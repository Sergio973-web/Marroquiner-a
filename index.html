<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gesti√≥n Marroquiner√≠a</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <!-- Librer√≠a para escaneo -->
  <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

  <div class="w-full max-w-3xl p-6 bg-white rounded-2xl shadow-lg">
    <h1 class="text-4xl font-extrabold text-center text-indigo-700 mb-2 cursor-pointer" onclick="location.reload()">Gesti√≥n Marroquiner√≠a</h1>
    <p class="text-center text-gray-600 text-lg mb-6">Sistema de Gesti√≥n Comercial - Marroquiner√≠a</p>

    <div class="grid grid-cols-2 gap-6 mb-8">
      <button onclick="mostrarFormulario('ingreso')" class="bg-indigo-600 hover:bg-indigo-700 text-white py-4 rounded-xl text-lg font-semibold">Ingreso Producto</button>
      <button onclick="mostrarFormulario('venta')" class="bg-green-600 hover:bg-green-700 text-white py-4 rounded-xl text-lg font-semibold">Venta Producto</button>
      <button onclick="mostrarFormulario('consulta')" class="bg-gray-700 hover:bg-gray-800 text-white py-4 rounded-xl text-lg font-semibold col-span-2">Consultas</button>
    </div>

    <div id="formulario" class="mt-4"></div>
  </div>

  <!-- Contenedor para el esc√°ner (oculto hasta activar) -->
  <div id="scanner-container" class="fixed inset-0 bg-black bg-opacity-75 flex flex-col items-center justify-center p-4 hidden z-50">
    <div id="reader" style="width:300px; max-width:90vw;"></div>
    <button onclick="cerrarScanner()" class="mt-4 bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded">Cerrar Esc√°ner</button>
  </div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAd_SRGQ2ZF4LZ-hSB7pgXW3db0pvXWMnY",
    authDomain: "arbol-generealogico-burke.firebaseapp.com",
    databaseURL: "https://arbol-generealogico-burke-default-rtdb.firebaseio.com",
    projectId: "arbol-generealogico-burke",
    storageBucket: "arbol-generealogico-burke.firebasestorage.app",
    messagingSenderId: "167250645470",
    appId: "1:167250645470:web:2dff2641859f505a09cd4f",
    measurementId: "G-X8KV1ZW18V"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  function parseDecimal(valor) {
    if (valor == null) return 0;
    valor = String(valor).trim().replace(',', '.');
    let num = parseFloat(valor);
    return isNaN(num) ? 0 : +num.toFixed(2);
  }

  let html5QrcodeScanner;
  let inputSkuActual = null;

  function abrirScanner(inputSkuId) {
    inputSkuActual = inputSkuId;
    document.getElementById('scanner-container').classList.remove('hidden');

    if (html5QrcodeScanner) {
      html5QrcodeScanner.clear().then(() => iniciarEscaneo()).catch(() => iniciarEscaneo());
    } else {
      iniciarEscaneo();
    }
  }

  function iniciarEscaneo() {
  html5QrcodeScanner = new Html5Qrcode("reader");
  const config = { fps: 10, qrbox: { width: 250, height: 250 } };

  html5QrcodeScanner.start(
    { facingMode: "environment" },
    config,
    (decodedText) => {
      html5QrcodeScanner.stop();
      document.getElementById('scanner-container').classList.add('hidden');

      const codigoLimpio = decodedText.slice(-4); // <-- ¬°Usar los √∫ltimos 4 d√≠gitos!

      if (inputSkuActual) {
        const input = document.getElementById(inputSkuActual);
        if (input) {
          input.value = codigoLimpio;
          input.dispatchEvent(new Event('blur'));
        }
      }
    },
    (_) => {}
  ).catch(err => {
    alert('Error iniciando la c√°mara: ' + err);
    document.getElementById('scanner-container').classList.add('hidden');
  });
}


  function cerrarScanner() {
    if(html5QrcodeScanner){
      html5QrcodeScanner.stop().then(() => html5QrcodeScanner.clear()).catch(() => {});
    }
    document.getElementById('scanner-container').classList.add('hidden');
  }

  window.mostrarFormulario = function(tipo) {
  const cont = document.getElementById('formulario');
  cont.innerHTML = '';

  if (tipo === 'ingreso') {
  cont.innerHTML = `
    <h2 class="text-2xl font-bold mb-4 text-indigo-700">Ingreso de Producto</h2>
    <form id="form-ingreso" class="grid grid-cols-1 gap-4">
      <div class="flex items-center space-x-2">
        <input id="sku-ingreso" class="border p-2 rounded flex-grow" type="text" placeholder="C√≥digo SKU" required />
        <button type="button" onclick="abrirScanner('sku-ingreso')" class="bg-indigo-500 hover:bg-indigo-600 text-white px-3 py-2 rounded">Escanear C√≥digo</button>
      </div>
      <input class="border p-2 rounded" type="text" placeholder="Tipo (Ej: Cartera, Billetera)" required />
      <input class="border p-2 rounded" type="number" min="0" step="0.01" placeholder="Precio de compra" required />
      <input class="border p-2 rounded" type="number" min="0" step="0.01" placeholder="Precio de venta" required />
      <input class="border p-2 rounded" type="number" min="0" step="0.01" placeholder="Precio promocional (opcional)" id="precio-promocional" />
      <input class="border p-2 rounded" type="number" min="0" step="1" placeholder="Cantidad m√≠nima para promoci√≥n (opcional)" id="cantidad-promocion" />
      <input class="border p-2 rounded" type="date" required />
      <textarea class="border p-2 rounded" placeholder="Observaciones"></textarea>
      <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded">Guardar Producto</button>
    </form>
  `;
} 
 else if (tipo === 'venta') {
  cont.innerHTML = `
    <h2 class="text-2xl font-bold mb-4 text-green-700">Registrar Venta</h2>
    <form id="form-venta" class="grid grid-cols-1 gap-4">
      <input id="fecha" class="border p-2 rounded" type="date" />
      <input id="cliente" class="border p-2 rounded" type="text" placeholder="Nombre y Apellido Cliente" />
      <input id="dni" class="border p-2 rounded" type="text" placeholder="DNI Cliente" />

      <div class="relative flex items-center space-x-2">
        <input id="sku-buscar" autocomplete="off" class="border p-2 rounded flex-grow" type="text" placeholder="C√≥digo SKU Producto" />
        <button type="button" onclick="abrirScanner('sku-buscar')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded">Escanear C√≥digo</button>
      </div>
      <div id="sugerencias-sku" class="absolute bg-white border border-gray-300 rounded w-full max-h-40 overflow-auto z-50 mt-1" style="display:none;"></div>

      <div id="datos-producto" class="bg-gray-100 p-4 rounded hidden">
        <p><strong>Tipo:</strong> <span id="venta-tipo"></span></p>
        <p><strong>Precio aplicado:</strong> $<span id="venta-precio"></span></p>
        <label>Cantidad:
          <input id="venta-cantidad" type="number" value="1" min="1" class="border p-2 rounded w-full" />
        </label>
      </div>

      <p class="text-xl font-bold">Precio final: $<span id="precio-final">0</span></p>

      <button type="submit" class="bg-green-600 hover:bg-green-700 text-white py-2 rounded">Registrar Venta</button>
    </form>
  `;

  const form = document.getElementById('form-venta');
  const skuInput = document.getElementById('sku-buscar');
  const sugerenciasCont = document.getElementById('sugerencias-sku');
  const precioSpan = document.getElementById('venta-precio');
  const tipoSpan = document.getElementById('venta-tipo');
  const finalSpan = document.getElementById('precio-final');
  const cantidadInput = document.getElementById('venta-cantidad');
  const datosProducto = document.getElementById('datos-producto');

  let productoActual = null;

  skuInput.addEventListener('input', buscarYMostrarProducto);
  skuInput.addEventListener('change', buscarYMostrarProducto);

  function buscarYMostrarProducto() {
  let texto = skuInput.value.trim().toLowerCase();

  // No acortes a 4 si ya es menor
  if (texto.length > 4) {
    texto = texto.slice(-4); // nos quedamos con los √∫ltimos 4 caracteres
    skuInput.value = texto;  // actualizamos el input visualmente
  }

  if (!texto) {
    sugerenciasCont.style.display = 'none';
    datosProducto.classList.add('hidden');
    productoActual = null;
    precioSpan.textContent = '0.00';
    finalSpan.textContent = '0.00';
    return;
  }

  // B√∫squeda local
  let producto = productos[texto];

  if (!producto) {
    // Buscar por los √∫ltimos 2 d√≠gitos
    for (const sku in productos) {
      if (sku.slice(-2).toLowerCase() === texto) {
        producto = productos[sku];
        break;
      }
    }
  }

  if (producto) {
    mostrarDatosProducto(producto);
  } else {
    datosProducto.classList.add('hidden');
    productoActual = null;
    precioSpan.textContent = '0.00';
    finalSpan.textContent = '0.00';
  }

  // B√∫squeda en Firebase
  const endText = texto + "\uf8ff";

  db.ref('marroquineria')
    .orderByChild('codigoSKU')
    .startAt(texto)
    .endAt(endText)
    .limitToFirst(10)
    .once('value', snapshot => {
      if (!snapshot.exists()) {
        sugerenciasCont.style.display = 'none';
        return;
      }

      const productosDB = snapshot.val();
      const arrProd = Object.values(productosDB);

      sugerenciasCont.innerHTML = arrProd.map(prod =>
        `<div class="cursor-pointer px-3 py-2 hover:bg-green-100 border-b border-gray-200" 
          data-sku="${prod.codigoSKU}" 
          data-tipo="${prod.tipo}" 
          data-precio="${prod.precioVenta}" 
          data-promocion="${prod.precioPromocional || 0}" 
          data-cantidad-promo="${prod.cantidadPromo || 0}">
          <strong>${prod.codigoSKU}</strong> ‚Äî ${prod.tipo} ‚Äî $${parseFloat(prod.precioVenta).toFixed(2)}
        </div>`
      ).join('');
      sugerenciasCont.style.display = 'block';

      // Listener a cada sugerencia
      Array.from(sugerenciasCont.children).forEach(div => {
        div.addEventListener('click', () => {
          skuInput.value = div.dataset.sku;
          tipoSpan.textContent = div.dataset.tipo || '';
          productoActual = {
            sku: div.dataset.sku,
            tipo: div.dataset.tipo,
            precio: parseFloat(div.dataset.precio) || 0,
            promocion: parseFloat(div.dataset.promocion) || 0,
            cantidadPromo: parseInt(div.dataset['cantidad-promo']) || 0
          };
          calcularPrecioFinal();
          datosProducto.classList.remove('hidden');
          sugerenciasCont.style.display = 'none';
          skuInput.focus();
        });
      });
    });
}


  skuInput.addEventListener('blur', () => {
    setTimeout(() => {
      sugerenciasCont.style.display = 'none';
    }, 200);
  });

  cantidadInput.addEventListener('input', calcularPrecioFinal);

  function calcularPrecioFinal() {
    if (!productoActual) return;

    const cantidad = parseInt(cantidadInput.value) || 1;
    let precioAplicado = productoActual.precio;

    if (productoActual.promocion > 0 && cantidad >= productoActual.cantidadPromo) {
      precioAplicado = productoActual.promocion;
    }

    precioSpan.textContent = precioAplicado.toFixed(2);
    finalSpan.textContent = (precioAplicado * cantidad).toFixed(2);
  }

  function mostrarDatosProducto(producto) {
    productoActual = producto;
    tipoSpan.textContent = producto.tipo || '';
    precioSpan.textContent = parseFloat(producto.precioVenta || producto.precio || 0).toFixed(2);
    calcularPrecioFinal();
    datosProducto.classList.remove('hidden');
  }

  form.addEventListener('submit', (e) => {
    e.preventDefault();

    const fecha = document.getElementById('fecha').value || new Date().toISOString().split('T')[0];
    const cliente = document.getElementById('cliente').value.trim();
    const dni = document.getElementById('dni').value.trim();
    const sku = skuInput.value.trim();
    const tipo = tipoSpan.textContent.trim();
    const precio = parseFloat(precioSpan.textContent) || 0;
    const total = parseFloat(finalSpan.textContent) || 0;
    const cantidad = parseInt(cantidadInput.value) || 1;

    if (!sku || !tipo || precio === 0) {
      alert('Debe seleccionar un producto v√°lido.');
      return;
    }

    const venta = {
      fecha,
      cliente,
      dni,
      sku,
      tipo,
      precioUnitario: precio,
      total,
      cantidad
    };

    db.ref('ventas').push(venta, (error) => {
      if (error) {
        alert('Error al guardar la venta.');
      } else {
        alert('Venta registrada correctamente.');
        location.reload(); // recarga la p√°gina para resetear formulario
      }
    });
  });
}


    else if (tipo === 'consulta') {
    cont.innerHTML = `
      <h2 class="text-2xl font-bold mb-4 text-gray-700">Consultas</h2>
      <label class="block mb-4">
        <span class="text-gray-700">Seleccionar tipo:</span>
        <select id="tipo-consulta" class="border p-2 rounded w-full">
          <option value="marroquineria">Productos</option>
          <option value="ventas_marroquineria">Ventas</option>
        </select>
      </label>
      <div id="tabla-consultas" class="overflow-x-auto mt-4"></div>
    `;

    document.getElementById('tipo-consulta').addEventListener('change', cargarConsulta);
    cargarConsulta();
  }
};

  function cargarConsulta() {
    const tipo = document.getElementById('tipo-consulta').value;
    const tablaCont = document.getElementById('tabla-consultas');

    db.ref(tipo).limitToLast(10).once('value', snapshot => {
      if (!snapshot.exists()) {
        tablaCont.innerHTML = `<p class="text-gray-600">No hay datos para mostrar.</p>`;
        return;
      }

      const datos = snapshot.val();
      const entradas = Object.entries(datos);
      const claves = Object.keys(entradas[0][1] || {});

      let html = `<table class="min-w-full bg-white border border-gray-300">
        <thead>
          <tr>
            ${claves.map(c => `<th class="px-4 py-2 border">${c}</th>`).join('')}
            <th class="px-4 py-2 border">Acciones</th>
          </tr>
        </thead>
        <tbody>
          ${entradas.map(([key, item]) => `
            <tr>
              ${claves.map(clave => `<td class="px-4 py-2 border text-sm">${item[clave] ?? ''}</td>`).join('')}
              <td class="px-4 py-2 border text-center">
                <button onclick="editarItem('${tipo}', '${key}')" class="text-blue-600 hover:underline">‚úèÔ∏è</button>
                <button onclick="eliminarItem('${tipo}', '${key}')" class="text-red-600 hover:underline ml-2">üóëÔ∏è</button>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>`;

      tablaCont.innerHTML = html;
    });
  }

  function eliminarItem(tipo, id) {
    if (confirm('¬øEst√°s seguro de eliminar este registro?')) {
      db.ref(`${tipo}/${id}`).remove().then(() => {
        alert('Registro eliminado');
        cargarConsulta();
      }).catch(e => alert('Error al eliminar: ' + e.message));
    }
  }

  function editarItem(tipo, id) {
  db.ref(`${tipo}/${id}`).once('value', snapshot => {
    if (!snapshot.exists()) {
      alert('Registro no encontrado');
      return;
    }

    const datos = snapshot.val();

    let modal = document.getElementById('modal-editar');
    if (!modal) {
      modal = document.createElement('div');
      modal.id = 'modal-editar';
      modal.style.position = 'fixed';
      modal.style.top = '0';
      modal.style.left = '0';
      modal.style.width = '100%';
      modal.style.height = '100%';
      modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
      modal.style.display = 'flex';
      modal.style.justifyContent = 'center';
      modal.style.alignItems = 'center';
      modal.style.zIndex = '9999';
      document.body.appendChild(modal);
    }

    modal.innerHTML = `
      <div style="
        background:#fff; 
        padding:20px; 
        border-radius:8px; 
        max-width:400px; 
        width:90%; 
        max-height: 90vh; 
        overflow-y: auto;
        box-sizing: border-box;
        box-shadow: 0 0 15px rgba(0,0,0,0.3);
      ">
        <h2 style="margin-bottom:1rem;">Editar Producto</h2>
        <form id="form-editar-producto">
          <label>
            C√≥digo SKU:<br/>
            <input type="text" name="codigoSKU" value="${datos.codigoSKU || ''}" required style="width:100%; padding:0.5rem; margin-bottom:1rem;"/>
          </label>
          <label>
            Tipo:<br/>
            <input type="text" name="tipo" value="${datos.tipo || ''}" required style="width:100%; padding:0.5rem; margin-bottom:1rem;"/>
          </label>
          <label>
            Precio Compra:<br/>
            <input type="number" name="precioCompra" value="${datos.precioCompra || 0}" step="0.01" min="0" required style="width:100%; padding:0.5rem; margin-bottom:1rem;"/>
          </label>
          <label>
            Precio Venta:<br/>
            <input type="number" name="precioVenta" value="${datos.precioVenta || 0}" step="0.01" min="0" required style="width:100%; padding:0.5rem; margin-bottom:1rem;"/>
          </label>
          <label>
            Precio Promocional:<br/>
            <input type="number" name="precioPromocional" value="${datos.precioPromocional || 0}" step="0.01" min="0" style="width:100%; padding:0.5rem; margin-bottom:1rem;"/>
          </label>
          <label>
            Cantidad m√≠nima para promoci√≥n:<br/>
            <input type="number" name="cantidadPromo" value="${datos.cantidadPromo || 0}" min="0" style="width:100%; padding:0.5rem; margin-bottom:1rem;"/>
          </label>
          <label>
            Fecha ingreso:<br/>
            <input type="date" name="fechaIngreso" value="${datos.fechaIngreso || ''}" required style="width:100%; padding:0.5rem; margin-bottom:1rem;"/>
          </label>
          <label>
            Observaciones:<br/>
            <textarea name="observaciones" style="width:100%; padding:0.5rem; margin-bottom:1rem;" rows="3">${datos.observaciones || ''}</textarea>
          </label>
          <div style="text-align:right;">
            <button type="button" id="btn-cancelar" style="margin-right:10px; padding:0.5rem 1rem;">Cancelar</button>
            <button type="submit" style="
              background:#4CAF50; 
              color:#fff; 
              padding:0.5rem 1rem; 
              border:none; 
              border-radius:4px;
              cursor:pointer;
            ">Guardar</button>
          </div>
        </form>
      </div>
    `;

    modal.style.display = 'flex';

    document.getElementById('btn-cancelar').onclick = () => {
      modal.style.display = 'none';
    };

    document.getElementById('form-editar-producto').onsubmit = (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);

      const productoEditado = {
        codigoSKU: formData.get('codigoSKU').trim(),
        tipo: formData.get('tipo').trim(),
        precioCompra: parseFloat(formData.get('precioCompra')) || 0,
        precioVenta: parseFloat(formData.get('precioVenta')) || 0,
        precioPromocional: parseFloat(formData.get('precioPromocional')) || 0,
        cantidadPromo: parseInt(formData.get('cantidadPromo')) || 0,
        fechaIngreso: formData.get('fechaIngreso'),
        observaciones: formData.get('observaciones').trim()
      };

      db.ref(`${tipo}/${id}`).update(productoEditado)
        .then(() => {
          alert('Producto actualizado correctamente');
          modal.style.display = 'none';
          cargarConsulta(); // recarga tabla con datos actualizados
        })
        .catch(e => alert('Error al actualizar: ' + e.message));
    };
  });
}



  // Manejo global de formularios ingreso y venta
  document.addEventListener('submit', e => {
    if (e.target.id === 'form-ingreso') {
      e.preventDefault();
      const form = e.target;
      const inputs = form.querySelectorAll('input, select, textarea');

      // --- Normalizo el SKU a min√∫sculas y quito espacios en ingreso
      let skuIngreso = inputs[0].value.trim().toLowerCase();

      // No valido regex para permitir cualquier tipo de c√≥digo, solo que no est√© vac√≠o
      if (!skuIngreso) {
        alert('Debe ingresar un C√≥digo SKU v√°lido.');
        return;
      }

      let producto = {
        codigoSKU: skuIngreso,
        tipo: inputs[1].value.trim(),
        
        precioCompra: parseDecimal(inputs[2].value),
        precioVenta: parseDecimal(inputs[3].value),
        fechaIngreso: inputs[4].value,
        observaciones: inputs[5].value.trim()
      };

      // Compruebo si ya existe el producto con ese SKU (igual en min√∫sculas)
      db.ref('marroquineria').orderByChild('codigoSKU').equalTo(skuIngreso).once('value', snapshot => {
        if (snapshot.exists()) {
          alert('Ya existe un producto con ese C√≥digo SKU.');
        } else {
          db.ref('marroquineria').push(producto)
            .then(() => {
              alert('Producto guardado correctamente');
              form.reset();
            })
            .catch(e => alert('Error al guardar: ' + e.message));
        }
      });
    }

    if (e.target.id === 'form-venta') {
      e.preventDefault();
      const form = e.target;
      const inputs = form.querySelectorAll('input, select');

      let codigoSKUVenta = inputs[3].value.trim();

      if (!codigoSKUVenta) {
        alert('Debe ingresar un C√≥digo SKU v√°lido.');
        return;
      }

      const venta = {
        fecha: inputs[0].value,
        clienteNombre: inputs[1].value.trim(),
        clienteDNI: inputs[2].value.trim(),
        codigoSKU: codigoSKUVenta,
        bonificacionPorc: parseDecimal(document.getElementById('bonificacion').value),
        formaPago: document.getElementById('forma-pago').value,
        moneda: document.getElementById('moneda').value,
        precioFinal: parseDecimal(document.getElementById('precio-final').textContent)
      };
     
      db.ref('ventas_marroquineria').push(venta)
        .then(() => {
          alert('Venta registrada correctamente');
          form.reset();
          document.getElementById('datos-producto').classList.add('hidden');
          document.getElementById('precio-final').textContent = '0';
        })
        .catch(e => alert('Error al registrar venta: ' + e.message));
    }
  });
</script>

</body>
</html>
