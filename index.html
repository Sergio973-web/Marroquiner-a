<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gestión Marroquinería</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <!-- Librería para escaneo -->
  <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

  <div class="w-full max-w-3xl p-6 bg-white rounded-2xl shadow-lg">
    <h1 class="text-4xl font-extrabold text-center text-indigo-700 mb-2 cursor-pointer" onclick="location.reload()">Gestión Marroquinería</h1>
    <p class="text-center text-gray-600 text-lg mb-6">Sistema de Gestión Comercial - Marroquinería</p>

    <div class="grid grid-cols-2 gap-6 mb-8">
      <button onclick="mostrarFormulario('ingreso')" class="bg-indigo-600 hover:bg-indigo-700 text-white py-4 rounded-xl text-lg font-semibold">Ingreso Producto</button>
      <button onclick="mostrarFormulario('venta')" class="bg-green-600 hover:bg-green-700 text-white py-4 rounded-xl text-lg font-semibold">Venta Producto</button>
      <button onclick="mostrarFormulario('consulta')" class="bg-gray-700 hover:bg-gray-800 text-white py-4 rounded-xl text-lg font-semibold col-span-2">Consultas</button>
    </div>

    <div id="formulario" class="mt-4"></div>
  </div>

  <!-- Contenedor para el escáner (oculto hasta activar) -->
  <div id="scanner-container" class="fixed inset-0 bg-black bg-opacity-75 flex flex-col items-center justify-center p-4 hidden z-50">
    <div id="reader" style="width:300px; max-width:90vw;"></div>
    <button onclick="cerrarScanner()" class="mt-4 bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded">Cerrar Escáner</button>
  </div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAd_SRGQ2ZF4LZ-hSB7pgXW3db0pvXWMnY",
    authDomain: "arbol-generealogico-burke.firebaseapp.com",
    databaseURL: "https://arbol-generealogico-burke-default-rtdb.firebaseio.com",
    projectId: "arbol-generealogico-burke",
    storageBucket: "arbol-generealogico-burke.firebasestorage.app",
    messagingSenderId: "167250645470",
    appId: "1:167250645470:web:2dff2641859f505a09cd4f",
    measurementId: "G-X8KV1ZW18V"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  function parseDecimal(valor) {
    if (valor == null) return 0;
    valor = String(valor).trim().replace(',', '.');
    let num = parseFloat(valor);
    return isNaN(num) ? 0 : +num.toFixed(2);
  }

  let html5QrcodeScanner;
  let inputSkuActual = null;

  function abrirScanner(inputSkuId) {
    inputSkuActual = inputSkuId;
    document.getElementById('scanner-container').classList.remove('hidden');

    if (html5QrcodeScanner) {
      html5QrcodeScanner.clear().then(() => iniciarEscaneo()).catch(() => iniciarEscaneo());
    } else {
      iniciarEscaneo();
    }
  }

  function iniciarEscaneo() {
    html5QrcodeScanner = new Html5Qrcode("reader");
    const config = { fps: 10, qrbox: {width: 250, height: 250} };

    html5QrcodeScanner.start(
      { facingMode: "environment" },
      config,
      (decodedText) => {
        html5QrcodeScanner.stop();
        document.getElementById('scanner-container').classList.add('hidden');
        if(inputSkuActual) {
          const input = document.getElementById(inputSkuActual);
          if(input){
            input.value = decodedText.slice(-5);
            input.dispatchEvent(new Event('blur'));
          }
        }
      },
      (_) => {}
    ).catch(err => {
      alert('Error iniciando la cámara: ' + err);
      document.getElementById('scanner-container').classList.add('hidden');
    });
  }

  function cerrarScanner() {
    if(html5QrcodeScanner){
      html5QrcodeScanner.stop().then(() => html5QrcodeScanner.clear()).catch(() => {});
    }
    document.getElementById('scanner-container').classList.add('hidden');
  }

  window.mostrarFormulario = function(tipo) {
  const cont = document.getElementById('formulario');
  cont.innerHTML = '';

  if (tipo === 'ingreso') {
  cont.innerHTML = `
    <h2 class="text-2xl font-bold mb-4 text-indigo-700">Ingreso de Producto</h2>
    <form id="form-ingreso" class="grid grid-cols-1 gap-4">
      <div class="flex items-center space-x-2">
        <input id="sku-ingreso" class="border p-2 rounded flex-grow" type="text" placeholder="Código SKU" required />
        <button type="button" onclick="abrirScanner('sku-ingreso')" class="bg-indigo-500 hover:bg-indigo-600 text-white px-3 py-2 rounded">Escanear Código</button>
      </div>
      <input class="border p-2 rounded" type="text" placeholder="Tipo (Ej: Cartera, Billetera)" required />
      <input class="border p-2 rounded" type="number" min="0" step="0.01" placeholder="Precio de compra" required />
      <input class="border p-2 rounded" type="number" min="0" step="0.01" placeholder="Precio de venta" required />
      <input class="border p-2 rounded" type="number" min="0" step="0.01" placeholder="Precio promocional (opcional)" id="precio-promocional" />
      <input class="border p-2 rounded" type="number" min="0" step="1" placeholder="Cantidad mínima para promoción (opcional)" id="cantidad-promocion" />
      <input class="border p-2 rounded" type="date" required />
      <textarea class="border p-2 rounded" placeholder="Observaciones"></textarea>
      <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded">Guardar Producto</button>
    </form>
  `;
} 
else if (tipo === 'venta') {
  cont.innerHTML = `
    <h2 class="text-2xl font-bold mb-4 text-green-700">Registrar Venta</h2>
    <form id="form-venta" class="grid grid-cols-1 gap-4">
      <input id="fecha" class="border p-2 rounded" type="date" />
      <input id="cliente" class="border p-2 rounded" type="text" placeholder="Nombre y Apellido Cliente" />
      <input id="dni" class="border p-2 rounded" type="text" placeholder="DNI Cliente" />

      <div class="relative flex items-center space-x-2">
        <input id="sku-buscar" autocomplete="off" class="border p-2 rounded flex-grow" type="text" placeholder="Código SKU Producto" />
        <button type="button" onclick="abrirScanner('sku-buscar')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded">Escanear Código</button>
      </div>
      <div id="sugerencias-sku" class="absolute bg-white border border-gray-300 rounded w-full max-h-40 overflow-auto z-50 mt-1" style="display:none;"></div>

      <div id="datos-producto" class="bg-gray-100 p-4 rounded hidden">
        <p><strong>Tipo:</strong> <span id="venta-tipo"></span></p>
        <p><strong>Precio aplicado:</strong> $<span id="venta-precio"></span></p>
        <label>Cantidad:
          <input id="venta-cantidad" type="number" value="1" min="1" class="border p-2 rounded w-full" />
        </label>
      </div>

      <p class="text-xl font-bold">Precio final: $<span id="precio-final">0</span></p>

      <label>Forma de pago:
        <select class="border p-2 rounded w-full" id="forma-pago">
          <option value="">Seleccionar</option>
          <option value="efectivo">Efectivo</option>
          <option value="transferencia">Transferencia</option>
          <option value="tarjeta">Tarjeta de crédito</option>
        </select>
      </label>

      <label>Moneda:
        <select class="border p-2 rounded w-full" id="moneda">
          <option value="ARS">Pesos</option>
          <option value="USD">Dólares</option>
        </select>
      </label>

      <button type="submit" class="bg-green-600 hover:bg-green-700 text-white py-2 rounded">Registrar Venta</button>
    </form>
  `;

  const form = document.getElementById('form-venta');
  const skuInput = document.getElementById('sku-buscar');
  const sugerenciasCont = document.getElementById('sugerencias-sku');
  const precioSpan = document.getElementById('venta-precio');
  const tipoSpan = document.getElementById('venta-tipo');
  const finalSpan = document.getElementById('precio-final');
  const cantidadInput = document.getElementById('venta-cantidad');
  const datosProducto = document.getElementById('datos-producto');

  let productoActual = null;

  skuInput.addEventListener('input', buscarYMostrarProducto);
  skuInput.addEventListener('change', buscarYMostrarProducto);

  function buscarYMostrarProducto() {
    const texto = skuInput.value.trim().toLowerCase();
    if (!texto) {
      sugerenciasCont.style.display = 'none';
      datosProducto.classList.add('hidden');
      productoActual = null;
      precioSpan.textContent = '0.00';
      finalSpan.textContent = '0.00';
      return;
    }

    const endText = texto + "\uf8ff";

    db.ref('marroquineria')
      .orderByChild('codigoSKU')
      .startAt(texto)
      .endAt(endText)
      .limitToFirst(10)
      .once('value', snapshot => {
        if (!snapshot.exists()) {
          sugerenciasCont.style.display = 'none';
          return;
        }
        const productos = snapshot.val();
        const arrProd = Object.values(productos);

        sugerenciasCont.innerHTML = arrProd.map(prod =>
          `<div class="cursor-pointer px-3 py-2 hover:bg-green-100 border-b border-gray-200" 
            data-sku="${prod.codigoSKU}" 
            data-tipo="${prod.tipo}" 
            data-precio="${prod.precioVenta}" 
            data-promocion="${prod.precioPromocional || 0}" 
            data-cantidad-promo="${prod.cantidadPromo || 0}">
            <strong>${prod.codigoSKU}</strong> — ${prod.tipo} — $${parseFloat(prod.precioVenta).toFixed(2)}
          </div>`
        ).join('');
        sugerenciasCont.style.display = 'block';

        Array.from(sugerenciasCont.children).forEach(div => {
          div.addEventListener('click', () => {
            skuInput.value = div.dataset.sku;
            tipoSpan.textContent = div.dataset.tipo || '';
            productoActual = {
              sku: div.dataset.sku,
              tipo: div.dataset.tipo,
              precio: parseFloat(div.dataset.precio) || 0,
              promocion: parseFloat(div.dataset.promocion) || 0,
              cantidadPromo: parseInt(div.dataset['cantidad-promo']) || 0
            };
            calcularPrecioFinal();
            datosProducto.classList.remove('hidden');
            sugerenciasCont.style.display = 'none';
            skuInput.focus();
          });
        });
      });
  }

  skuInput.addEventListener('blur', () => {
    setTimeout(() => {
      sugerenciasCont.style.display = 'none';
    }, 200);
  });

  cantidadInput.addEventListener('input', calcularPrecioFinal);

  function calcularPrecioFinal() {
    if (!productoActual) return;

    const cantidad = parseInt(cantidadInput.value) || 1;
    let precioAplicado = productoActual.precio;

    if (productoActual.promocion > 0 && cantidad >= productoActual.cantidadPromo) {
      precioAplicado = productoActual.promocion;
    }

    precioSpan.textContent = precioAplicado.toFixed(2);
    finalSpan.textContent = (precioAplicado * cantidad).toFixed(2);
  }

  form.addEventListener('submit', (e) => {
    e.preventDefault();

    const fecha = document.getElementById('fecha').value || new Date().toISOString().split('T')[0];
    const cliente = document.getElementById('cliente').value.trim();
    const dni = document.getElementById('dni').value.trim();
    const sku = skuInput.value.trim();
    const tipo = tipoSpan.textContent.trim();
    const formaPago = document.getElementById('forma-pago').value;
    const moneda = document.getElementById('moneda').value;
    const precio = parseFloat(precioSpan.textContent) || 0;
    const total = parseFloat(finalSpan.textContent) || 0;
    const cantidad = parseInt(cantidadInput.value) || 1;

    if (!sku || !tipo || precio === 0) {
      alert('Debe seleccionar un producto válido.');
      return;
    }

    const venta = {
      fecha,
      cliente,
      dni,
      sku,
      tipo,
      precioUnitario: precio,
      total,
      formaPago,
      moneda,
      cantidad
    };

    db.ref('ventas').push(venta, (error) => {
      if (error) {
        alert('Error al guardar la venta.');
      } else {
        alert('Venta registrada correctamente.');
        cargarApp();
      }
    });
  });
}

  else if (tipo === 'consulta') {
    cont.innerHTML = `
      <h2 class="text-2xl font-bold mb-4 text-gray-700">Consultas</h2>
      <label class="block mb-4">
        <span class="text-gray-700">Seleccionar tipo:</span>
        <select id="tipo-consulta" class="border p-2 rounded w-full">
          <option value="marroquineria">Productos</option>
          <option value="ventas_marroquineria">Ventas</option>
        </select>
      </label>
      <div id="tabla-consultas" class="overflow-x-auto mt-4"></div>
    `;

    document.getElementById('tipo-consulta').addEventListener('change', cargarConsulta);
    cargarConsulta();
  }
};

  function cargarConsulta() {
    const tipo = document.getElementById('tipo-consulta').value;
    const tablaCont = document.getElementById('tabla-consultas');

    db.ref(tipo).limitToLast(10).once('value', snapshot => {
      if (!snapshot.exists()) {
        tablaCont.innerHTML = `<p class="text-gray-600">No hay datos para mostrar.</p>`;
        return;
      }

      const datos = snapshot.val();
      const entradas = Object.entries(datos);
      const claves = Object.keys(entradas[0][1] || {});

      let html = `<table class="min-w-full bg-white border border-gray-300">
        <thead>
          <tr>
            ${claves.map(c => `<th class="px-4 py-2 border">${c}</th>`).join('')}
            <th class="px-4 py-2 border">Acciones</th>
          </tr>
        </thead>
        <tbody>
          ${entradas.map(([key, item]) => `
            <tr>
              ${claves.map(clave => `<td class="px-4 py-2 border text-sm">${item[clave] ?? ''}</td>`).join('')}
              <td class="px-4 py-2 border text-center">
                <button onclick="editarItem('${tipo}', '${key}')" class="text-blue-600 hover:underline">✏️</button>
                <button onclick="eliminarItem('${tipo}', '${key}')" class="text-red-600 hover:underline ml-2">🗑️</button>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>`;

      tablaCont.innerHTML = html;
    });
  }

  function eliminarItem(tipo, id) {
    if (confirm('¿Estás seguro de eliminar este registro?')) {
      db.ref(`${tipo}/${id}`).remove().then(() => {
        alert('Registro eliminado');
        cargarConsulta();
      }).catch(e => alert('Error al eliminar: ' + e.message));
    }
  }

  function editarItem(tipo, id) {
    alert('Función de edición aún no implementada para simplificar.');
  }

  // Manejo global de formularios ingreso y venta
  document.addEventListener('submit', e => {
    if (e.target.id === 'form-ingreso') {
      e.preventDefault();
      const form = e.target;
      const inputs = form.querySelectorAll('input, select, textarea');

      // --- Normalizo el SKU a minúsculas y quito espacios en ingreso
      let skuIngreso = inputs[0].value.trim().toLowerCase();

      // No valido regex para permitir cualquier tipo de código, solo que no esté vacío
      if (!skuIngreso) {
        alert('Debe ingresar un Código SKU válido.');
        return;
      }

      let producto = {
        codigoSKU: skuIngreso,
        tipo: inputs[1].value.trim(),
        
        precioCompra: parseDecimal(inputs[2].value),
        precioVenta: parseDecimal(inputs[3].value),
        fechaIngreso: inputs[4].value,
        observaciones: inputs[5].value.trim()
      };

      // Compruebo si ya existe el producto con ese SKU (igual en minúsculas)
      db.ref('marroquineria').orderByChild('codigoSKU').equalTo(skuIngreso).once('value', snapshot => {
        if (snapshot.exists()) {
          alert('Ya existe un producto con ese Código SKU.');
        } else {
          db.ref('marroquineria').push(producto)
            .then(() => {
              alert('Producto guardado correctamente');
              form.reset();
            })
            .catch(e => alert('Error al guardar: ' + e.message));
        }
      });
    }

    if (e.target.id === 'form-venta') {
      e.preventDefault();
      const form = e.target;
      const inputs = form.querySelectorAll('input, select');

      let codigoSKUVenta = inputs[3].value.trim();

      if (!codigoSKUVenta) {
        alert('Debe ingresar un Código SKU válido.');
        return;
      }

      const venta = {
        fecha: inputs[0].value,
        clienteNombre: inputs[1].value.trim(),
        clienteDNI: inputs[2].value.trim(),
        codigoSKU: codigoSKUVenta,
        bonificacionPorc: parseDecimal(document.getElementById('bonificacion').value),
        formaPago: document.getElementById('forma-pago').value,
        moneda: document.getElementById('moneda').value,
        precioFinal: parseDecimal(document.getElementById('precio-final').textContent)
      };
     
      db.ref('ventas_marroquineria').push(venta)
        .then(() => {
          alert('Venta registrada correctamente');
          form.reset();
          document.getElementById('datos-producto').classList.add('hidden');
          document.getElementById('precio-final').textContent = '0';
        })
        .catch(e => alert('Error al registrar venta: ' + e.message));
    }
  });
</script>

</body>
</html>
